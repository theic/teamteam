<link rel="import" href="/components/paper-input/paper-input.html">
<link rel="import" href="/components/paper-button/paper-button.html">
<link rel="import" href="/components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="/components/gold-email-input/gold-email-input.html">

<link rel="import" href="/components/polymer/polymer.html">

<link rel="import" href="/components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="/components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="/components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="/components/neon-animation/animations/slide-down-animation.html">
<link rel="import" href="/components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="/components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="/src/teamteam-app/app-data.html">

<link rel="import" href="/components/iron-ajax/iron-ajax.html">

<dom-module id="login-form">
    <template>
        <style>
            :host {
                display: inline-block;
                width: 100%;
                /*background-color: #EF5458;*/
                padding-left: 20px;
                padding-right: 20px;
            }

            paper-input-container {
                font-family: 'Roboto', Helvetica, sans-serif;
                --paper-input-container-color: white;
                --paper-input-container-focus-color: white;
                --paper-input-container-input-color: white;
                margin-right: 20px;
            }

            gold-email-input {
                font-family: 'Roboto', Helvetica, sans-serif;
                --paper-input-container-color: white;
                --paper-input-container-focus-color: white;
                --paper-input-container-input-color: white;
                margin-right: 20px;
            }

            paper-button {
                font-size: 16px;
            }

            paper-tooltip {
                --paper-tooltip-background: white;
                --paper-tooltip-text-color: #757575;
            }

            div {
                display: inline-block;
                /*background-color: #EF5458;*/
                vertical-align: middle;
                height: 100%;
            }
        </style>

        <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
        <app-data key="userData" data="{{storedUser}}"></app-data>

        <iron-ajax
                id="registerLoginAjax"
                method="post"
                content-type="application/json"
                handle-as="text"
                on-response="handleUserResponse"
                on-error="handleUserError"></iron-ajax>


        <div>
            <gold-email-input id="email" label="Почта" bind-value="{{formData.email}}" spacer></gold-email-input>
        </div>
        <div>
            <paper-input-container>
                <label>Пароль</label>
                <input id="password" type="password" bind-value="{{formData.password}}" is="iron-input">
            </paper-input-container>
        </div>
        <div style="height: auto;">
            <paper-button id="addUser" on-tap="postLogin">Вперед</paper-button>
        </div>
        <paper-tooltip for="addUser">Нажмите "Вперед", чтобы войти или зарегистрироваться</paper-tooltip>


    </template>
    <script>
        (function () {
            Polymer({
                is: 'login-form',
                properties: {
                    formData: {
                        type: Object,
                        value: {}
                    },
                    storedUser: Object,
                    error: String
                },
                _setReqBody: function () {
                    this.$.registerLoginAjax.body = this.formData;
                },
                postLogin: function () {
                    this.$.registerLoginAjax.url = 'http://localhost:3000/login';
                    this._setReqBody();
                    this.$.registerLoginAjax.generateRequest();
                },
                postRegister: function () {
                    this.$.registerLoginAjax.url = 'http://localhost:3000/users';
                    this._setReqBody();
                    this.$.registerLoginAjax.generateRequest();
                },
                handleUserResponse: function (event) {
                    var response = JSON.parse(event.detail.response);
                    console.log(response.message);
                    if (response.sid) {//(response.id_token) {
                        this.error = '';
                        this.storedUser = {
                            name: this.formData.email,
                            userid: response.userid,
                            sessionid: response.sid,
                            loggedin: true
                        };

                        this.set('route.path', '/home-page');
                    }
                    // reset form data
                    this.formData = {};
                },
                handleUserError: function (event) {
                    this.error = event.detail.request.xhr.response;
                }
            });
        }());
    </script>
</dom-module>